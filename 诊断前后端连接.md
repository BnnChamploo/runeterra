# 前后端连接诊断指南

## 问题排查步骤

### 1. 检查浏览器控制台（最重要）

打开 `https://BnnChamploo.github.io/runeterra`，按 `F12` 打开开发者工具：

**查看 Console 标签：**
- 是否有红色错误信息？
- 是否有 CORS 相关错误？
- 是否有 "Failed to fetch" 或 "Network error"？

**查看 Network 标签：**
- 刷新页面
- 找到对 `/api/posts` 或 `/api/login` 的请求
- 点击请求，查看：
  - **Request URL**: 应该是 `https://runeterra-api.fly.dev/api/posts`
  - **Status Code**: 应该是 `200` 或 `401`
  - **Response Headers**: 查看 `Access-Control-Allow-Origin` 是否包含你的域名

### 2. 测试后端 API 是否正常

在浏览器控制台的 Console 中运行：

```javascript
// 测试获取帖子
fetch('https://runeterra-api.fly.dev/api/posts')
  .then(r => r.json())
  .then(data => console.log('帖子数据:', data))
  .catch(err => console.error('错误:', err));

// 测试登录
fetch('https://runeterra-api.fly.dev/api/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ username: '阿狸', password: '1234567' })
})
  .then(r => r.json())
  .then(data => console.log('登录结果:', data))
  .catch(err => console.error('错误:', err));
```

### 3. 检查前端配置

在浏览器控制台运行：

```javascript
// 检查 API 配置
console.log('当前域名:', window.location.hostname);
console.log('当前 URL:', window.location.href);

// 检查 localStorage
console.log('Token:', localStorage.getItem('token'));
console.log('User:', localStorage.getItem('user'));
```

### 4. 常见问题

**问题 1: CORS 错误**
- 错误信息：`Access to fetch at '...' from origin '...' has been blocked by CORS policy`
- 解决：等待后端重新部署完成（已修复 CORS 配置）

**问题 2: 404 错误**
- 错误信息：`Failed to fetch` 或 `404 Not Found`
- 解决：检查 API URL 是否正确指向 `https://runeterra-api.fly.dev`

**问题 3: 前端还在使用旧版本**
- 解决：强制刷新浏览器（`Ctrl+Shift+R` 或 `Cmd+Shift+R`）
- 或者：等待 GitHub Actions 完成部署（约 2-5 分钟）

**问题 4: 登录失败但 API 正常**
- 可能是前端没有正确发送请求
- 检查 Network 标签中的登录请求，查看请求体和响应

## 当前修复内容

1. ✅ 改进了前端生产环境判断逻辑
2. ✅ 改进了后端 CORS 配置（更准确地匹配 GitHub Pages 域名）
3. ✅ 后端 API 已验证正常工作

## 下一步

1. **等待后端重新部署**（如果还没部署，运行：`cd server && ~/.fly/bin/fly deploy`）
2. **等待 GitHub Actions 完成前端部署**（查看：https://github.com/BnnChamploo/runeterra/actions）
3. **强制刷新浏览器**（`Ctrl+Shift+R`）
4. **按照上面的步骤检查浏览器控制台**

